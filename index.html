<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZarzÄ…dzanie Zleceniami z ZXing</title>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    .input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
    }
    video {
      width: 100%;
      margin-top: 10px;
      display: none;
      border: 1px solid #ccc;
    }
    #scannerStatus {
      font-size: 14px;
      color: red;
      margin-top: 10px;
    }
    .entry {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
      display: flex;
      flex-direction: column;
    }
    .entry-buttons {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }
    .entry-buttons button {
      flex: 1;
      font-size: 12px;
      padding: 5px;
    }
  </style>
</head>
<body>

  <h2>Nowe Zlecenie</h2>
  <div class="input-group">
    <input type="text" id="orderNumber" placeholder="Numer zlecenia" />
    <button onclick="startScanner('orderNumber')">ðŸ“·</button>
  </div>
  <div class="input-group">
    <input type="text" id="assignedPerson" placeholder="Osoba przypisana" />
    <button onclick="startScanner('assignedPerson')">ðŸ“·</button>
  </div>
  <button onclick="addEntry()">Dodaj</button>

  <div id="scannerStatus"></div>
  <video id="video" autoplay muted></video>

  <hr/>
  <h3>Lista ZleceÅ„</h3>
  <div id="entries"></div>

  <button onclick="exportToCSV()">Eksportuj do CSV</button>
  <button onclick="clearAll()">WyczyÅ›Ä‡ wszystko</button>

  <script>
    let entries = [];
    let codeReader = null;

    function loadEntries() {
      const saved = localStorage.getItem("entries");
      entries = saved ? JSON.parse(saved) : [];
      renderEntries();
    }

    function saveEntries() {
      localStorage.setItem("entries", JSON.stringify(entries));
    }

    function addEntry() {
      const order = document.getElementById("orderNumber").value.trim();
      const person = document.getElementById("assignedPerson").value.trim();

      if (!order || !person) {
        alert("WypeÅ‚nij oba pola!");
        return;
      }

      entries.push({ order, person });
      saveEntries();
      renderEntries();

      document.getElementById("orderNumber").value = "";
      document.getElementById("assignedPerson").value = "";
      stopScanner();
    }

    function renderEntries() {
      const container = document.getElementById("entries");
      container.innerHTML = "";

      entries.forEach((entry, index) => {
        const div = document.createElement("div");
        div.className = "entry";

        div.innerHTML = `
          <strong>${entry.order}</strong><br/>
          Przypisane do: ${entry.person}
          <div class="entry-buttons">
            <button onclick="editEntry(${index})">Edytuj</button>
            <button onclick="deleteEntry(${index})">UsuÅ„</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function deleteEntry(index) {
      if (confirm("Czy na pewno usunÄ…Ä‡ ten wpis?")) {
        entries.splice(index, 1);
        saveEntries();
        renderEntries();
      }
    }

    function editEntry(index) {
      const entry = entries[index];
      const newOrder = prompt("ZmieÅ„ numer zlecenia:", entry.order);
      const newPerson = prompt("ZmieÅ„ osobÄ™ przypisanÄ…:", entry.person);

      if (newOrder !== null && newPerson !== null) {
        entries[index] = { order: newOrder.trim(), person: newPerson.trim() };
        saveEntries();
        renderEntries();
      }
    }

    function exportToCSV() {
      const csvRows = [];
      csvRows.push(["Numer zlecenia", "Przypisana osoba"].join(";"));

      entries.forEach(entry => {
        csvRows.push([entry.order, entry.person].join(";"));
      });

      const csvString = csvRows.join("\n");
      const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "zlecenia.csv");
      link.click();
    }

    function clearAll() {
      if (confirm("Czy na pewno wyczyÅ›ciÄ‡ wszystkie zlecenia?")) {
        entries = [];
        saveEntries();
        renderEntries();
      }
    }

    function startScanner(inputId) {
  const video = document.getElementById("video");
  const status = document.getElementById("scannerStatus");
  video.style.display = "block";
  status.innerText = "Uruchamianie kamery...";

  codeReader = new ZXing.BrowserMultiFormatReader();

  codeReader
    .listVideoInputDevices()
    .then(videoInputDevices => {
      // SZUKAJ KAMERY TYLNEJ
      let backCamera = videoInputDevices.find(device =>
        device.label.toLowerCase().includes("back") || device.label.toLowerCase().includes("rear")
      );

      // JeÅ›li nie znaleziono, uÅ¼yj pierwszej dostÄ™pnej
      const deviceId = backCamera ? backCamera.deviceId : videoInputDevices[0].deviceId;

      return codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
        if (result) {
          document.getElementById(inputId).value = result.text;
          stopScanner();
          status.innerText = "Zeskanowano!";
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
          status.innerText = "BÅ‚Ä…d skanowania.";
        }
      });
    })
    .then(() => {
      status.innerText = "Skanowanie...";
    })
    .catch(err => {
      console.error(err);
      status.innerText = "Nie moÅ¼na uruchomiÄ‡ kamery. Upewnij siÄ™, Å¼e masz HTTPS lub localhost.";
    });
}

    function stopScanner() {
      const video = document.getElementById("video");
      const status = document.getElementById("scannerStatus");
      if (codeReader) {
        codeReader.reset();
        codeReader = null;
      }
      video.style.display = "none";
      status.innerText = "";
    }

    window.onload = loadEntries;
  </script>

</body>
</html>
